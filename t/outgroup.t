use strict;
use warnings;
use Test::More 'no_plan';
use FindBin '$Bin';
use Bio::Phylo::IO 'parse_tree';
use Bio::Phylo::Util::Logger ':levels';
use Bio::Phylo::PhyLoTA::Service::TreeService;
use Bio::Phylo::PhyLoTA::Domain::MarkersAndTaxa;

my $ts  = Bio::Phylo::PhyLoTA::Service::TreeService->new;
my $mt  = Bio::Phylo::PhyLoTA::Domain::MarkersAndTaxa->new;
#my $log = Bio::Phylo::Util::Logger->new(
#	'-level'  => DEBUG,
#	'-method' => 'Bio::Phylo::PhyLoTA::Service::TreeService::outgroup_root',
#	'-style'  => 'simple',
#);
my @records = $mt->parse_taxa_file("${Bin}/testdata/species.tsv");

my $tree = parse_tree(
	'-format' => 'newick',
	'-handle' => \*DATA,
);

$ts->remap_to_ti($tree,@records);

$ts->outgroup_root(
	'-tree'     => $tree,
	'-outgroup' => [ 'Strepsirrhini' ],
	'-records'  => \@records,
);

$ts->remap_to_name($tree);

my $rerooted = $tree->to_newick;
ok( $rerooted, $rerooted );

# should result in the following, more or less topologically correct, rerooting:
# (((((Tarsius_bancanus:0.026290,Tarsius_syrichta:0.037665):0.298335,((Nycticebus_pygmaeus:0.047045,Nycticebus_coucang:0.044109):0.076148,(Loris_tardigradus:0.117248,((Arctocebus_calabarensis:0.072712,Perodicticus_potto:0.058245):0.057807,(((Otolemur_crassicaudatus:0.031744,Otolemur_garnettii:0.038684):0.033835,(Euoticus_elegantulus:0.031613,(Galago_moholi:0.018153,Galago_senegalensis:0.022626):0.021954):0.030869):0.017979,Galagoides_demidoff:0.078349):0.047310):0.004658):0.025605):0.084909):0.015204,Daubentonia_madagascariensis:0.112753):0.006177,(((Allocebus_trichotis:0.049427,(Mirza_coquereli:0.061041,(Microcebus_murinus:0.040137,Microcebus_rufus:0.047012):0.029484):0.006004):0.035170,(Cheirogaleus_major:0.049667,Cheirogaleus_medius:0.063150):0.012596):0.031410,(((Propithecus_diadema:0.025222,Propithecus_tattersalli:0.032675):0.029542,Avahi_laniger:0.089892):0.040602,((Phaner_furcifer:0.091834,(Lepilemur_septentrionalis:0.050928,Lepilemur_leucopus:0.076905):0.053132):0.017617,((Hapalemur_aureus:0.046305,Lemur_catta:0.047547):0.015398,(Hapalemur_simus:0.046092,(Varecia_variegata:0.046785,(Eulemur_coronatus:0.027806,Eulemur_rubriventer:0.057368):0.000000):0.014387):0.036139):0.015741):0.042081):0.005828):0.007221):0.065475,(((((Ateles_fusciceps:0.001248,Ateles_belzebuth_chamek:0.008286):0.019673,(Lagothrix_lagotricha:0.043027,Brachyteles_arachnoides:0.043783):0.066504):0.000789,(Alouatta_caraya:0.010452,Alouatta_palliata:0.033762):0.057616):0.007906,((((Chiropotes_satanas:0.010510,(Cacajao_melanocephalus:0.014620,(Chiropotes_albinasus:0.000002,Cacajao_calvus:0.109814):0.000002):0.015751):0.004064,(Pithecia_irrorata:0.003070,Pithecia_pithecia:0.001961):0.030214):0.021249,(Callicebus_personatus:0.011372,Callicebus_cupreus:0.010121):0.042664):0.011238,((Aotus_trivirgatus:0.046950,Aotus_azarai_infulatus:0.014748):0.040132,(((Saimiri_ustus:0.000787,Saimiri_sciureus:0.021383):0.057870,(Cebus_albifrons:0.025538,Cebus_apella:0.020658):0.034920):0.006361,(Saguinus_midas:0.056111,(Saguinus_labiatus:0.164906,(((Leontopithecus_chrysopygus:0.000002,Leontopithecus_rosalia:0.000002):0.053374,(Callithrix_pygmaea:0.022051,Callithrix_humeralifera:0.003876):0.040260):0.006047,Callimico_goeldii:0.042216):0.021537):0.026630):0.027138):0.001919):0.008713):0.002500):0.071670,((((Hylobates_lar:0.022283,Hylobates_muelleri:0.025137):0.010901,(Symphalangus_syndactylus:0.039059,(Hoolock_hoolock:0.034577,(Nomascus_concolor:0.012623,Nomascus_gabriellae:0.026003):0.020956):0.001990):0.002843):0.031594,((Gorilla_gorilla:0.031986,(Homo_sapiens:0.110750,(Pan_paniscus:0.014838,Pan_troglodytes:0.021300):0.008816):0.012769):0.035070,Pongo_pygmaeus:0.047388):0.019621):0.031240,(((((Cercopithecus_lhoesti:0.019349,Erythrocebus_patas:0.002529):0.023575,(Allenopithecus_nigroviridis:0.061644,Miopithecus_talapoin:0.029678):0.013244):0.010552,(Chlorocebus_aethiops:0.045240,Cercopithecus_diana:0.064161):0.011183):0.020270,((Macaca_sylvanus:0.040574,Macaca_ochreata:0.029960):0.013782,((Papio_hamadryas:0.016326,(Lophocebus_albigena:0.032553,Theropithecus_gelada:0.009979):0.029378):0.016218,(Cercocebus_torquatus:0.018352,(Mandrillus_sphinx:0.021353,(Cercocebus_galeritus:0.017272,Mandrillus_leucophaeus:0.009664):0.006557):0.005772):0.014608):0.003551):0.011275):0.014787,(((Colobus_guereza:0.014699,Colobus_angolensis:0.036941):0.039486,(Procolobus_verus:0.037862,Piliocolobus_badius:0.014912):0.025197):0.010075,((((Trachypithecus_francoisi:0.005627,Trachypithecus_auratus:0.003969):0.003020,Semnopithecus_entellus:0.018078):0.034364,(Presbytis_melalophos:0.001213,Presbytis_comata:0.000002):0.014342):0.000002,((Pygathrix_nemaeus:0.045347,(Rhinopithecus_roxellana:0.016268,Rhinopithecus_bieti:0.021965):0.021712):0.010427,(Simias_concolor:0.010478,Nasalis_larvatus:0.024532):0.032346)):0.017887):0.025490):0.034477):0.054382):0.119610);
# it is just that Tarsius is in this case placed within the Strepsirhini, but that can happen

__DATA__
((Pygathrix_nemaeus:0.045347,(Rhinopithecus_roxellana:0.016268,Rhinopithecus_bieti:0.021965):0.021712):0.010427,((Simias_concolor:0.010478,Nasalis_larvatus:0.024532):0.024882,((((Trachypithecus_francoisi:0.005627,Trachypithecus_auratus:0.003969):0.003020,Semnopithecus_entellus:0.018078):0.034364,(Presbytis_melalophos:0.001213,Presbytis_comata:0.000002):0.014342):0.000002,(((Colobus_guereza:0.014699,Colobus_angolensis:0.036941):0.039486,(Procolobus_verus:0.037862,Piliocolobus_badius:0.014912):0.025197):0.010075,(((((Cercopithecus_lhoesti:0.019349,Erythrocebus_patas:0.002529):0.023575,(Allenopithecus_nigroviridis:0.061644,Miopithecus_talapoin:0.029678):0.013244):0.010552,(Chlorocebus_aethiops:0.045240,Cercopithecus_diana:0.064161):0.011183):0.020270,((Macaca_sylvanus:0.040574,Macaca_ochreata:0.029960):0.013782,((Papio_hamadryas:0.016326,(Lophocebus_albigena:0.032553,Theropithecus_gelada:0.009979):0.029378):0.016218,(Cercocebus_torquatus:0.018352,(Mandrillus_sphinx:0.021353,(Cercocebus_galeritus:0.017272,Mandrillus_leucophaeus:0.009664):0.006557):0.005772):0.014608):0.003551):0.011275):0.014787,((((Hylobates_lar:0.022283,Hylobates_muelleri:0.025137):0.010901,(Symphalangus_syndactylus:0.039059,(Hoolock_hoolock:0.034577,(Nomascus_concolor:0.012623,Nomascus_gabriellae:0.026003):0.020956):0.001990):0.002843):0.031594,((Gorilla_gorilla:0.031986,(Homo_sapiens:0.110750,(Pan_paniscus:0.014838,Pan_troglodytes:0.021300):0.008816):0.012769):0.035070,Pongo_pygmaeus:0.047388):0.019621):0.031240,(((((Ateles_fusciceps:0.001248,Ateles_belzebuth_chamek:0.008286):0.019673,(Lagothrix_lagotricha:0.043027,Brachyteles_arachnoides:0.043783):0.066504):0.000789,(Alouatta_caraya:0.010452,Alouatta_palliata:0.033762):0.057616):0.007906,((((Chiropotes_satanas:0.010510,(Cacajao_melanocephalus:0.014620,(Chiropotes_albinasus:0.000002,Cacajao_calvus:0.109814):0.000002):0.015751):0.004064,(Pithecia_irrorata:0.003070,Pithecia_pithecia:0.001961):0.030214):0.021249,(Callicebus_personatus:0.011372,Callicebus_cupreus:0.010121):0.042664):0.011238,((Aotus_trivirgatus:0.046950,Aotus_azarai_infulatus:0.014748):0.040132,(((Saimiri_ustus:0.000787,Saimiri_sciureus:0.021383):0.057870,(Cebus_albifrons:0.025538,Cebus_apella:0.020658):0.034920):0.006361,(Saguinus_midas:0.056111,(Saguinus_labiatus:0.164906,(((Leontopithecus_chrysopygus:0.000002,Leontopithecus_rosalia:0.000002):0.053374,(Callithrix_pygmaea:0.022051,Callithrix_humeralifera:0.003876):0.040260):0.006047,Callimico_goeldii:0.042216):0.021537):0.026630):0.027138):0.001919):0.008713):0.002500):0.071670,((((Tarsius_bancanus:0.026290,Tarsius_syrichta:0.037665):0.298335,((Nycticebus_pygmaeus:0.047045,Nycticebus_coucang:0.044109):0.076148,(Loris_tardigradus:0.117248,((Arctocebus_calabarensis:0.072712,Perodicticus_potto:0.058245):0.057807,(((Otolemur_crassicaudatus:0.031744,Otolemur_garnettii:0.038684):0.033835,(Euoticus_elegantulus:0.031613,(Galago_moholi:0.018153,Galago_senegalensis:0.022626):0.021954):0.030869):0.017979,Galagoides_demidoff:0.078349):0.047310):0.004658):0.025605):0.084909):0.015204,Daubentonia_madagascariensis:0.112753):0.006177,(((Allocebus_trichotis:0.049427,(Mirza_coquereli:0.061041,(Microcebus_murinus:0.040137,Microcebus_rufus:0.047012):0.029484):0.006004):0.035170,(Cheirogaleus_major:0.049667,Cheirogaleus_medius:0.063150):0.012596):0.031410,(((Propithecus_diadema:0.025222,Propithecus_tattersalli:0.032675):0.029542,Avahi_laniger:0.089892):0.040602,((Phaner_furcifer:0.091834,(Lepilemur_septentrionalis:0.050928,Lepilemur_leucopus:0.076905):0.053132):0.017617,((Hapalemur_aureus:0.046305,Lemur_catta:0.047547):0.015398,(Hapalemur_simus:0.046092,(Varecia_variegata:0.046785,(Eulemur_coronatus:0.027806,Eulemur_rubriventer:0.057368):0.000000):0.014387):0.036139):0.015741):0.042081):0.005828):0.007221):0.065475):0.119610):0.054382):0.034477):0.025490):0.010423):0.007464);